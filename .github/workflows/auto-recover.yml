name: Auto-Recovery on Deploy

on:
  deployment_status:

jobs:
  health-check:
    name: Health Check & Auto-Recover
    runs-on: ubuntu-latest
    if: github.event.deployment_status.state == 'success'
    steps:
      - uses: actions/checkout@v4
      
      - name: Check deployment health
        id: health
        run: |
          sleep 10  # Wait for services to stabilize
          
          BACKEND_URL="${{ github.event.deployment_status.target_url }}"
          
          if curl -sf "$BACKEND_URL/api/health" > /dev/null; then
            echo "healthy=true" >> $GITHUB_OUTPUT
          else
            echo "healthy=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Trigger rollback if unhealthy
        if: steps.health.outputs.healthy == 'false'
        run: |
          echo "‚ö†Ô∏è  Deployment is unhealthy, triggering rollback..."
          # Trigger rollback via API or webhook
          curl -X POST "${{ secrets.DEPLOYMENT_ROLLBACK_WEBHOOK }}" \
            -H "Content-Type: application/json" \
            -d '{"deployment_id": "${{ github.event.deployment.id }}", "reason": "health_check_failed"}' || true
      
      - name: Notify on failure
        if: steps.health.outputs.healthy == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üö® Deployment Health Check Failed',
              body: `Deployment to ${{ github.event.deployment_status.environment }} failed health check.
              
              **Deployment:** ${{ github.event.deployment.sha }}
              **Environment:** ${{ github.event.deployment_status.environment }}
              **Time:** ${new Date().toISOString()}
              
              Auto-rollback has been triggered.`,
              labels: ['deployment', 'critical', 'automated']
            })
