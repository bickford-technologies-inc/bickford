name: PR Explain Failures

on:
  workflow_run:
    workflows: ["Bickford Non-Regression Invariants"]
    types: [completed]

jobs:
  explain:
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const runId = context.payload.workflow_run.id;

            const runs = await github.rest.actions.listWorkflowRunLogs({
              owner, repo, run_id: runId
            });

            const body = `
‚ùå **Bickford Invariant Violation**

Your PR failed a *locked build invariant*.  
See the failing step above for the exact rule.

üìú Canon: `docs/BUILD_CANON.md`  
ü©∫ Local fix: `npm run doctor`

This is a safety stop, not a lint nit.
`;

            await github.rest.issues.createComment({
              owner, repo,
              issue_number: context.payload.workflow_run.pull_requests[0].number,
              body
            });
