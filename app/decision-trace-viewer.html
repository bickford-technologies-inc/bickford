// This file is a Vercel-ready static HTML screen for the Decision Trace Viewer.
// To use, deploy this file as a static asset or as the root page in a Vercel project.

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Decision Trace Viewer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'security': {
                            50: '#f8fafc',
                            100: '#f1f5f9',
                            200: '#e2e8f0',
                            300: '#cbd5e1',
                            400: '#94a3b8',
                            500: '#64748b',
                            600: '#475569',
                            700: '#334155',
                            800: '#1e293b',
                            900: '#0f172a',
                        }
                    },
                    fontFamily: {
                        'mono': ['ui-monospace', 'SFMono-Regular', 'Monaco', 'Consolas', 'Liberation Mono', 'Menlo', 'monospace'],
                    }
                },
            },
        }
    </script>
    <style>
        body {
            font-family: ui-monospace, SFMono-Regular, Monaco, Consolas, Liberation Mono, Menlo, monospace;
        }
        .decision-card {
            @apply bg-gray-800 border border-gray-700 rounded-lg p-6 shadow-lg;
        }
        .hash-display {
            @apply font-mono text-xs bg-gray-700 px-2 py-1 rounded border border-gray-600 text-gray-300 break-all cursor-pointer;
        }
        .hash-display:hover {
            @apply bg-gray-600;
        }
        .enforcement-badge {
            @apply inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium;
        }
        .severity-hard-stop {
            @apply bg-red-900 text-red-300 border border-red-700;
        }
        .severity-warning {
            @apply bg-yellow-900 text-yellow-300 border border-yellow-700;
        }
        .severity-log-only {
            @apply bg-blue-900 text-blue-300 border border-blue-700;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
    <!-- Header -->
    <header class="border-b border-gray-700 bg-gray-800/50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-4">
                    <h1 class="text-xl font-semibold text-gray-100">
                        Decision Trace Viewer
                    </h1>
                    <span class="text-xs text-gray-400 bg-gray-700 px-2 py-1 rounded">
                        v1.0.0
                    </span>
                </div>
                <div class="text-xs text-gray-400">
                    Constitutional AI Enforcement Audit Trail
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div id="app">
            <!-- Upload Interface (Initial State) -->
            <div id="upload-interface" class="space-y-8">
                <!-- Welcome Section -->
                <div class="text-center space-y-4">
                    <h1 class="text-3xl font-bold text-gray-100">
                        Constitutional AI Enforcement Audit Trail
                    </h1>
                    <p class="text-gray-400 max-w-2xl mx-auto">
                        View deterministic enforcement decisions with cryptographic integrity. 
                        Upload a decision artifact to begin audit trail analysis.
                    </p>
                </div>

                <!-- Upload Area -->
                <div class="max-w-2xl mx-auto">
                    <div class="border-2 border-dashed border-gray-600 hover:border-gray-500 rounded-lg p-8 text-center transition-colors">
                        <input type="file" id="file-input" accept=".json" class="hidden">
                        <div class="space-y-4">
                            <div class="text-4xl">üìÑ</div>
                            <div>
                                <h3 class="text-lg font-medium text-gray-200 mb-2">
                                    Upload Decision Artifact
                                </h3>
                                <p class="text-gray-400 text-sm">
                                    Drop a JSON file here or click to browse
                                </p>
                                <p class="text-gray-500 text-xs mt-1">
                                    Supports bickford.build-diagnosis.v1 schema
                                </p>
                            </div>
                            <button onclick="document.getElementById('file-input').click()" 
                                    class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded transition-colors">
                                Choose File
                            </button>
                        </div>
                    </div>

                    <!-- Example Artifacts -->
                    <div class="space-y-3 mt-6">
                        <h4 class="text-sm font-medium text-gray-300 uppercase tracking-wide">
                            Load Example Artifacts
                        </h4>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                            <button onclick="loadExample('execution-halt')"
                                    class="p-3 bg-gray-800 border border-gray-700 rounded-lg hover:bg-gray-700 transition-colors text-left">
                                <div class="font-medium text-gray-200 text-sm">Execution Halt</div>
                                <div class="text-gray-400 text-xs">Missing guard enforcement</div>
                            </button>
                            
                            <button onclick="loadExample('content-filter')"
                                    class="p-3 bg-gray-800 border border-gray-700 rounded-lg hover:bg-gray-700 transition-colors text-left">
                                <div class="font-medium text-gray-200 text-sm">Content Filter</div>
                                <div class="text-gray-400 text-xs">Harmful content blocked</div>
                            </button>
                            
                            <button onclick="loadExample('access-deny')"
                                    class="p-3 bg-gray-800 border border-gray-700 rounded-lg hover:bg-gray-700 transition-colors text-left">
                                <div class="font-medium text-gray-200 text-sm">Access Deny</div>
                                <div class="text-gray-400 text-xs">Unauthorized access blocked</div>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Features Grid -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-12">
                    <div class="bg-gray-800/50 border border-gray-700 rounded-lg p-6">
                        <div class="text-2xl mb-3">üîí</div>
                        <h3 class="font-semibold text-gray-200 mb-2">Deterministic Authority</h3>
                        <p class="text-gray-400 text-sm">
                            View enforcement decisions based on constitutional principles, not model reasoning.
                        </p>
                    </div>
                    
                    <div class="bg-gray-800/50 border border-gray-700 rounded-lg p-6">
                        <div class="text-2xl mb-3">üîó</div>
                        <h3 class="font-semibold text-gray-200 mb-2">Cryptographic Integrity</h3>
                        <p class="text-gray-400 text-sm">
                            SHA-256 hashed artifacts with chain-of-custody for audit compliance.
                        </p>
                    </div>
                    
                    <div class="bg-gray-800/50 border border-gray-700 rounded-lg p-6">
                        <div class="text-2xl mb-3">üìã</div>
                        <h3 class="font-semibold text-gray-200 mb-2">Regulator Ready</h3>
                        <p class="text-gray-400 text-sm">
                            Export compliance reports for FedRAMP, SOC 2, and enterprise audits.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Viewer Interface (Hidden Initially) -->
            <div id="viewer-interface" class="space-y-8 hidden">
                <!-- Navigation -->
                <div class="flex items-center justify-between">
                    <button onclick="showUpload()" 
                            class="flex items-center space-x-2 text-gray-400 hover:text-gray-200 transition-colors">
                        <span>‚Üê</span>
                        <span>Back to Upload</span>
                    </button>
                    
                    <div class="flex items-center space-x-4">
                        <span id="schema-display" class="text-xs text-gray-500"></span>
                        <button onclick="exportReport()" 
                                class="text-xs bg-gray-700 hover:bg-gray-600 px-3 py-1 rounded border border-gray-600 transition-colors">
                            Export Report
                        </button>
                    </div>
                </div>

                <!-- Decision Card -->
                <div id="decision-card" class="bg-gray-800 border border-gray-700 rounded-lg p-6 shadow-lg">
                    <!-- Content will be populated by JavaScript -->
                </div>

                <!-- Placeholder for Timeline (Day 3) -->
                <div class="bg-gray-800/30 border border-gray-700 rounded-lg p-8 text-center">
                    <div class="text-gray-500 text-sm">
                        Timeline View ‚Ä¢ Authority Pane ‚Ä¢ Integrity Verification
                    </div>
                    <div class="text-gray-600 text-xs mt-1">
                        Coming in Day 3-4 implementation
                    </div>
                </div>
            </div>

            <!-- Error Display -->
            <div id="error-display" class="hidden bg-red-900/20 border border-red-700 rounded-lg p-4 max-w-2xl mx-auto">
                <div class="flex items-center space-x-2">
                    <span class="text-red-400">‚ö†Ô∏è</span>
                    <span class="text-red-300 font-medium">Upload Error</span>
                </div>
                <p id="error-message" class="text-red-200 text-sm mt-1"></p>
            </div>
        </div>
    </main>

    <script>
        // Example artifacts data
        const examples = {
            'execution-halt': {
                "schema": "bickford.build-diagnosis.v1",
                "timestamp": "2026-01-16T01:39:23Z",
                "decision": {
                    "type": "execution_halt",
                    "classification": "missing_guard",
                    "severity": "hard-stop",
                    "description": "Execution halted due to missing environment precondition guard"
                },
                "authority": {
                    "enforced_by": "precondition_guard",
                    "policy": "no_undefined_execution",
                    "constitutional_principle": "Prevent harmful or unpredictable system modifications",
                    "bypassable": false
                },
                "evidence": {
                    "exit_code": 127,
                    "command": "bash ci/guards/ENVIRONMENT_PRECONDITION.sh",
                    "output": "Guard script not found: ci/guards/ENVIRONMENT_PRECONDITION.sh",
                    "file_path": "ci/guards/ENVIRONMENT_PRECONDITION.sh"
                },
                "environment": {
                    "commit": "061eb46",
                    "executor": "vercel",
                    "region": "pdx1",
                    "user_id": "user_12345",
                    "session_id": "sess_abcdef"
                },
                "hash": "sha256:a1b2c3d4e5f6789012345678901234567890abcdef1234567890abcdef123456",
                "previous_hash": "sha256:9876543210fedcba0987654321fedcba0987654321fedcba0987654321fedcba"
            },
            'content-filter': {
                "schema": "bickford.build-diagnosis.v1",
                "timestamp": "2026-01-16T02:15:47Z",
                "decision": {
                    "type": "content_filter",
                    "classification": "unsafe_content",
                    "severity": "hard-stop",
                    "description": "Content generation blocked due to potential harm detection"
                },
                "authority": {
                    "enforced_by": "constitutional_ai_filter",
                    "policy": "no_harmful_content_generation",
                    "constitutional_principle": "Be helpful, harmless, and honest",
                    "bypassable": false
                },
                "evidence": {
                    "content_hash": "sha256:deadbeef1234567890abcdef1234567890abcdef1234567890abcdef12345678",
                    "output": "Content flagged for potential physical harm instructions",
                    "file_path": "user_request.txt"
                },
                "environment": {
                    "commit": "061eb46",
                    "executor": "claude_api",
                    "region": "us-west-2",
                    "user_id": "user_67890",
                    "session_id": "sess_ghijkl"
                },
                "hash": "sha256:b2c3d4e5f6789012345678901234567890abcdef1234567890abcdef1234567a",
                "previous_hash": "sha256:a1b2c3d4e5f6789012345678901234567890abcdef1234567890abcdef123456"
            },
            'access-deny': {
                "schema": "bickford.build-diagnosis.v1",
                "timestamp": "2026-01-16T03:22:11Z",
                "decision": {
                    "type": "access_deny",
                    "classification": "unauthorized_access",
                    "severity": "hard-stop",
                    "description": "Access denied to sensitive system configuration"
                },
                "authority": {
                    "enforced_by": "rbac_enforcer",
                    "policy": "principle_of_least_privilege",
                    "constitutional_principle": "Respect user privacy and system security boundaries",
                    "bypassable": false
                },
                "evidence": {
                    "command": "cat /etc/shadow",
                    "output": "Permission denied: insufficient privileges",
                    "file_path": "/etc/shadow",
                    "exit_code": 1
                },
                "environment": {
                    "commit": "061eb46",
                    "executor": "sandbox",
                    "region": "us-east-1",
                    "user_id": "user_11111",
                    "session_id": "sess_mnopqr"
                },
                "hash": "sha256:c3d4e5f6789012345678901234567890abcdef1234567890abcdef1234567ab2",
                "previous_hash": "sha256:b2c3d4e5f6789012345678901234567890abcdef1234567890abcdef1234567a"
            }
        };

        // Utility functions
        function formatTimestamp(timestamp) {
            const date = new Date(timestamp);
            return {
                utc: date.toISOString().replace('T', ' ').slice(0, 19) + ' UTC',
                local: date.toLocaleString()
            };
        }

        function getSeverityClass(severity) {
            switch (severity) {
                case 'hard-stop': return 'severity-hard-stop';
                case 'warning': return 'severity-warning';
                case 'log-only': return 'severity-log-only';
                default: return 'severity-hard-stop';
            }
        }

        function getStatusIcon(severity) {
            switch (severity) {
                case 'hard-stop': return 'üõë';
                case 'warning': return '‚ö†Ô∏è';
                case 'log-only': return '‚ÑπÔ∏è';
                default: return 'üõë';
            }
        }

        function getDecisionTypeDisplay(type) {
            return type.split('_').map(word => 
                word.charAt(0).toUpperCase() + word.slice(1)
            ).join(' ');
        }

        function showError(message) {
            document.getElementById('error-message').textContent = message;
            document.getElementById('error-display').classList.remove('hidden');
            setTimeout(() => {
                document.getElementById('error-display').classList.add('hidden');
            }, 5000);
        }

        function showUpload() {
            document.getElementById('upload-interface').classList.remove('hidden');
            document.getElementById('viewer-interface').classList.add('hidden');
        }

        function showViewer(artifact) {
            document.getElementById('upload-interface').classList.add('hidden');
            document.getElementById('viewer-interface').classList.remove('hidden');
            
            // Update schema display
            document.getElementById('schema-display').textContent = `Schema: ${artifact.schema}`;
            
            // Render decision card
            renderDecisionCard(artifact);
        }

        function renderDecisionCard(artifact) {
            const timestamps = formatTimestamp(artifact.timestamp);
            const severityClass = getSeverityClass(artifact.decision.severity);
            const statusIcon = getStatusIcon(artifact.decision.severity);
            const decisionType = getDecisionTypeDisplay(artifact.decision.type);

            const cardHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Left Column - Core Decision Info -->
                    <div class="space-y-4">
                        <div class="flex items-center justify-between">
                            <h2 class="text-2xl font-bold text-gray-100">
                                ${decisionType}
                            </h2>
                            <div class="flex items-center space-x-2">
                                <span class="text-lg">${statusIcon}</span>
                                <span class="enforcement-badge ${severityClass}">
                                    ${artifact.decision.severity.toUpperCase()}
                                </span>
                            </div>
                        </div>

                        <div class="space-y-3">
                            <div>
                                <label class="block text-xs font-medium text-gray-400 uppercase tracking-wide mb-1">
                                    Status
                                </label>
                                <div class="flex items-center space-x-2">
                                    <div class="w-2 h-2 bg-green-400 rounded-full"></div>
                                    <span class="text-gray-200 font-medium">Enforcement Succeeded</span>
                                </div>
                            </div>

                            <div>
                                <label class="block text-xs font-medium text-gray-400 uppercase tracking-wide mb-1">
                                    Classification
                                </label>
                                <span class="text-gray-200 font-medium">
                                    ${artifact.decision.classification.replace('_', ' ').toUpperCase()}
                                </span>
                            </div>

                            ${artifact.decision.description ? `
                            <div>
                                <label class="block text-xs font-medium text-gray-400 uppercase tracking-wide mb-1">
                                    Description
                                </label>
                                <p class="text-gray-200">${artifact.decision.description}</p>
                            </div>
                            ` : ''}
                        </div>
                    </div>

                    <!-- Right Column - Metadata -->
                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs font-medium text-gray-400 uppercase tracking-wide mb-1">
                                Timestamp
                            </label>
                            <div class="space-y-1">
                                <div class="text-gray-200 font-medium">${timestamps.utc}</div>
                                <div class="text-xs text-gray-400">Local: ${timestamps.local}</div>
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs font-medium text-gray-400 uppercase tracking-wide mb-1">
                                Artifact Hash
                            </label>
                            <div class="hash-display" onclick="copyToClipboard('${artifact.hash}')">
                                ${artifact.hash}
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs font-medium text-gray-400 uppercase tracking-wide mb-1">
                                Environment
                            </label>
                            <div class="space-y-1 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Executor:</span>
                                    <span class="text-gray-200">${artifact.environment.executor}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Commit:</span>
                                    <span class="text-gray-200 font-mono">${artifact.environment.commit}</span>
                                </div>
                                ${artifact.environment.region ? `
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Region:</span>
                                    <span class="text-gray-200">${artifact.environment.region}</span>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('decision-card').innerHTML = cardHTML;
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                // Could add a toast notification here
                console.log('Hash copied to clipboard');
            });
        }

        function loadExample(exampleName) {
            const artifact = examples[exampleName];
            if (artifact) {
                showViewer(artifact);
            } else {
                showError('Example not found');
            }
        }

        function exportReport() {
            // Placeholder for export functionality (Day 5)
            alert('Export functionality coming in Day 5 implementation');
        }

        // File upload handling
        document.getElementById('file-input').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const artifact = JSON.parse(e.target.result);
                        
                        // Basic validation
                        if (!artifact.schema || !artifact.schema.startsWith('bickford.build-diagnosis.')) {
                            throw new Error('Invalid schema format');
                        }
                        
                        if (!artifact.hash || !artifact.hash.startsWith('sha256:')) {
                            throw new Error('Invalid hash format');
                        }

                        showViewer(artifact);
                    } catch (err) {
                        showError(err.message || 'Invalid JSON format');
                    }
                };
                reader.readAsText(file);
            }
        });

        // Load execution-halt example by default for demo
        window.addEventListener('load', () => {
            // Uncomment to auto-load example on page load
            // loadExample('execution-halt');
        });
    </script>
</body>
</html>
